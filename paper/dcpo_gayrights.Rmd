---
output: 
  bookdown::pdf_document2:
    fig_caption: yes
    keep_tex: yes
    toc: no
    number_sections: no
    latex_engine: xelatex
    pandoc_args: --lua-filter=multibib.lua
    
title: |
  | Measuring Public Attitudes Toward Homosexuality
  | Across Countries and Over Time

date: "`r format(Sys.time(), '%B %d, %Y')`"
editor_options: 
  markdown: 
    wrap: sentence
tables: true # enable longtable and booktabs
citation_package: natbib
citeproc: false
fontsize: 12pt
indent: true
linestretch: 1.5 # double spacing using linestretch 1.5
bibliography:
  text: dcpo-gayrights.bib
  app: dcpo-gayrights-app.bib
biblio-style: apsr
citecolor: black
linkcolor: black
endnote: no
header-includes:
      - \usepackage{array}
      - \usepackage{caption}
      - \usepackage{graphicx}
      - \usepackage{siunitx}
      - \usepackage{colortbl}
      - \usepackage{multirow}
      - \usepackage{hhline}
      - \usepackage{calc}
      - \usepackage{tabularx}
      - \usepackage{threeparttable}
      - \usepackage{wrapfig}
      - \usepackage{fullpage}
      - \usepackage{lscape} #\usepackage{lscape} better for printing, page displayed vertically, content in landscape mode, \usepackage{pdflscape} better for screen, page displayed horizontally, content in landscape mode
      - \newcommand{\blandscape}{\begin{landscape}}
      - \newcommand{\elandscape}{\end{landscape}}
      - \usepackage{titlesec}
      - \titleformat*{\section}{\normalsize\bfseries}
      - \titleformat*{\subsection}{\normalsize\itshape}
      - \usepackage{titling} #use \maketitle repeatedly  
      - \renewcommand{\topfraction}{.85} # Adjust LaTeX placement rules per 
      - \renewcommand{\bottomfraction}{.7} # https://bookdown.org/yihui/rmarkdown-cookbook/figure-placement.html
      - \renewcommand{\textfraction}{.15}
      - \renewcommand{\floatpagefraction}{.66}
      - \setcounter{topnumber}{3}
      - \setcounter{bottomnumber}{3}
      - \setcounter{totalnumber}{4}
---

\pagenumbering{gobble}

# Authors {.unnumbered}
-   Byung-Deuk Woo, ORCID: <https://orcid.org/0000-0001-6902-7576>, Postdoctoral Researcher, Institute of Social Data Science, Pohang University of Science and Technology, [byungdeukwoo\@gmail.com](mailto:byungdeukwoo@gmail.com){.email}
-   Hyein Ko, ORCID: <https://orcid.org/0000-0002-9497-9656>, Doctoral Candidate, Department of Political Science, University of Iowa, [hyein-ko\@uiowa.edu](mailto:hyein-ko@uiowa.edu){.email}
-   Yuehong Cassandra Tai, ORCID: <https://orcid.org/0000-0001-7303-7443>, Postdoctoral Fellow, Center for Social Data Analytics, Pennsylvania State University, [yhcasstai\@psu.edu](mailto:yhcasstai@psu.edu){.email}
-   Yue Hu, ORCID: <https://orcid.org/0000-0002-2829-3971>, Associate Professor, Department of Political Science, Tsinghua University, [yuehu\@tsinghua.edu.cn](mailto:yuehu@tsinghua.edu.cn){.email}
-   Frederick Solt, ORCID: <https://orcid.org/0000-0002-3154-6132>, Associate Professor, Department of Political Science, University of Iowa, [frederick-solt\@uiowa.edu](mailto:frederick-solt@uiowa.edu){.email}

\pagebreak

```{=tex}
\renewcommand{\baselinestretch}{1}
\selectfont
\maketitle
\renewcommand{\baselinestretch}{1.5}
\selectfont
```

```{=tex}
\begin{abstract}
Lorem ipsum blah blah blah
\end{abstract}
```
\pagebreak

```{r setup, include=FALSE}
options(tinytex.verbose = TRUE)

knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  cache = TRUE,
  dpi = 600,
  fig.width = 7,
  fig.height = 4,
  plot = function(x, options)  {
    hook_plot_tex(x, options)
  }
)

# If `DCPOtools` is not yet installed:
# remotes::install_github("fsolt/DCPOtools")

if (!require(pacman)) install.packages("pacman")
library(pacman)
# load all the packages you will use below 
p_load(
  DCPOtools,
  cmdstanr,
  tidyverse,
  here,
  countrycode,
  patchwork,
  ggthemes,
  ggdist,
  imputeTS,
  rsdmx,
  osfr,
  tabulizer,
  brms,
  tidybayes,
  repmis,
  rvest,
  vroom,
  modelsummary,
  kableExtra
) 
```

```{r define_funs}
# define functions
validation_plot <- function(v_data_raw,
                            lab_x = .38, lab_y = 92,
                            theta_summary, theta_results,
                            survey = TRUE) {
    
    # defaults per https://stackoverflow.com/a/49167744/2620381
    if ("theta_summary" %in% ls(envir = .GlobalEnv) & missing(theta_summary))
        theta_summary <- get("theta_summary", envir = .GlobalEnv)
    if ("theta_results" %in% ls(envir = .GlobalEnv) & missing(theta_results))
        theta_results <- get("theta_results", envir = .GlobalEnv)

    median_val <- Vectorize(function(x) median(1:x),
                            vectorize.args = "x")
    if (survey) {    
      v_vars <- v_data_raw %>% 
        select(item0 = item) %>% 
        unique() %>% 
        mutate(v_val = str_extract(item0, "\\d+") %>% 
                 as.numeric() %>% 
                 median_val(.) %>%
                 `+`(.6) %>% 
                 round())
    
      validation_summarized <- v_data_raw %>% 
        DCPOtools::format_dcpo(scale_q = v_vars$item0[[1]], # these arguments are required
                               scale_cp = 1) %>% # but they don't matter
        pluck("data") %>% 
        mutate(item0 = str_remove(item, " \\d or higher"),
               title = factor(title, 
                              levels = v_data_raw %>%
                                pull(title) %>%
                                unique())) %>% 
        right_join(v_vars, by = "item0") %>%
        arrange(title) %>% 
        filter(str_detect(item, paste(v_val, "or higher"))) %>%
        mutate(iso2c = countrycode::countrycode(country,
                                                origin = "country.name",
                                                destination = "iso2c",
                                                warn = FALSE),
               prop = if_else(neg, 1-y_r/n_r, y_r/n_r),
               se = sqrt((prop*(1-prop))/n),
               prop_90 = prop + qnorm(.9)*se,
               prop_10 = prop - qnorm(.9)*se) %>%
        inner_join(theta_summary %>% select(-kk, -tt), by = c("country", "year"))
    } else {
      validation_summarized <- v_data_raw %>% 
        mutate(iso2c = countrycode::countrycode(country,
                                                origin = "country.name",
                                                destination = "iso2c",
                                                warn = FALSE),
               prop = prop,
               se = se,
               prop_90 = prop + qnorm(.9)*se,
               prop_10 = prop - qnorm(.9)*se) %>%
        inner_join(theta_summary %>% select(-kk, -tt), by = c("country", "year"))
    }
    
    validation_cor <- theta_results %>%
      inner_join(validation_summarized %>%
                   select(country, year, title, prop, se),
                 by = c("country", "year")) %>% 
      rowwise() %>% 
      mutate(sim = rnorm(1, mean = prop, sd = se)) %>% 
      ungroup() %>% 
      select(title, theta, sim, draw) %>% 
      nest(data = c(theta, sim)) %>% 
      mutate(r = lapply(data, function(df) cor(df)[2,1]) %>% 
               unlist()) %>%
      select(-data) %>% 
      group_by(title) %>% 
      summarize(r = paste("R =", sprintf("%.2f", round(mean(r), 2))))

    if ({validation_summarized %>%
        pull(country) %>%
        unique() %>% 
        length()} > 1) {
      val_plot <- validation_summarized %>%
        ggplot(aes(x = mean,
                   y = prop * 100)) +
        geom_segment(aes(x = q10, xend = q90,
                         y = prop * 100, yend = prop * 100),
                     na.rm = TRUE,
                     alpha = .2) +
        geom_segment(aes(x = mean, xend = mean,
                         y = prop_90 * 100, yend = prop_10 * 100),
                     na.rm = TRUE,
                     alpha = .2) +
        geom_smooth(method = 'lm', formula = 'y ~ x', se = FALSE) +
        facet_wrap(~ title, ncol = 4) +
        geom_label(data = validation_cor, aes(x = lab_x,
                                              y = lab_y,
                                              label = r),
                   size = 2)
    } else {
      val_plot <- validation_summarized %>%
        ggplot(aes(x = year,
                   y = mean)) +
        geom_line() +
        geom_ribbon(aes(ymin = q10,
                        ymax = q90,
                        linetype = NA),
                    alpha = .2) +
        geom_point(aes(y = prop),
                   fill = "black",
                   shape = 21,
                   size = .5,
                   na.rm = TRUE) +
        geom_path(aes(y = prop),
                  linetype = 3,
                  na.rm = TRUE,
                  alpha = .7) +
        geom_segment(aes(x = year, xend = year,
                         y = prop_90, yend = prop_10),
                     na.rm = TRUE,
                     alpha = .2) +
        facet_wrap(~ title, ncol = 4) +
        geom_label(data = validation_cor, aes(x = lab_x,
                                              y = lab_y,
                                              label = r),
                   size = 2)
    }
    
    return(val_plot)
}

covered_share_of_spanned <- function(dcpo_input_raw) {
  n_cy <- dcpo_input_raw %>%
    distinct(country, year) %>% 
    nrow()
  
  spanned_cy <- dcpo_input_raw %>% 
    group_by(country) %>% 
    summarize(years = max(year) - min(year) + 1) %>% 
    summarize(n = sum(years)) %>% 
    pull(n)
  
  {(n_cy/spanned_cy) * 100}
}

get_coef <- function(iv, results_df = coef_data, type = "both", width = .95) {
  result_var <- results_df %>% 
    filter(.width == width) %>% 
    pull(.variable) %>% 
    str_subset(iv)
  
  if (!type=="both") {
    res <- results_df %>% 
      filter(.variable == result_var & .width == width) %>% 
      pull({{type}})
  } else {
    sc <- results_df %>% 
      filter(.variable == result_var & .width == width) %>% 
      pull(std_coef)
    
    ci <- results_df %>% 
      filter(.variable == result_var & .width == width) %>% 
      pull(ci)
    
    res <- paste0(sc, " (95% c.i.: ", ci, ")")
  }
  
  return(res)
}

by2sd <- function(var) {
  dich <- stats::na.omit(unique(var)) %>% 
    sort() %>% 
    identical(c(0, 1))
  if (dich) 
    sd <- 1
  else 
    sd <- 2 * stats::sd(var, na.rm = TRUE)
  
  return(sd)
}

set.seed(324)
```


```{r dcpo_input_raw, include=FALSE, cache = TRUE, cache.extra = tools::md5sum(here::here("data-raw", "surveys_gm.csv"))}
surveys_gm <- read_csv(here::here("data-raw", "surveys_gm.csv"),
                        col_types = "cccc")

dcpo_input_raw <- DCPOtools::dcpo_setup(vars = surveys_gm,
                                        datapath = here::here("..",
                                                              "data", "dcpo_surveys"),
                                        file = here::here("data",
                                                          "dcpo_input_raw.csv"))
```

```{r gm_summary_stats}
dcpo_input_raw <- read_csv(here::here("data", "dcpo_input_raw.csv"),
                                  col_types = "cdcddcd")

process_dcpo_input_raw <- function(dcpo_input_raw_df) {
  dcpo_input_raw_df %>% 
  with_min_yrs(3) %>% 
  with_min_cy(5) %>% 
  group_by(country) %>% 
  mutate(cc_rank = n()) %>% 
  ungroup() %>% 
  arrange(-cc_rank)
} 

dcpo_input_raw1 <- process_dcpo_input_raw(dcpo_input_raw)

n_surveys <- surveys_gm %>%
  distinct(survey) %>% 
  nrow()

n_items <- dcpo_input_raw1 %>%
  distinct(item) %>% 
  nrow()

n_countries <- dcpo_input_raw1 %>%
  distinct(country) %>% 
  nrow()

n_cy <- dcpo_input_raw1 %>%
  distinct(country, year) %>% 
  nrow() %>% 
  scales::comma()

n_years <- as.integer(summary(dcpo_input_raw1$year)[6]-summary(dcpo_input_raw1$year)[1])

spanned_cy <- dcpo_input_raw1 %>% 
  group_by(country) %>% 
  summarize(years = max(year) - min(year) + 1) %>% 
  summarize(n = sum(years)) %>% 
  pull(n) %>% 
  scales::comma()

total_cy <- {n_countries * n_years} %>% 
  scales::comma()

year_range <- paste("from",
                    summary(dcpo_input_raw1$year)[1],
                    "to",
                    summary(dcpo_input_raw1$year)[6])

n_cyi <- dcpo_input_raw1 %>% 
  distinct(country, year, item) %>% 
  nrow() %>% 
  scales::comma()

back_to_numeric <- function(string_number) {
  string_number %>% 
    str_replace(",", "") %>% 
    as.numeric()
}

covered_share_of_spanned <- {back_to_numeric(n_cy)/back_to_numeric(spanned_cy) * 100}
```


# Examining the Source Data on Attitudes Toward Homosexuality
Surveys have often included questions about homosexuality over the past half-century, but the resulting data are both sparse and incomparable.
That is, these data are unavailable for many countries and years, and they are generated by many different survey items.
In all, we identified `r n_items` items that were asked in no fewer than five country-years in countries surveyed at least twice; these items were drawn from `r n_surveys` different national and cross-national survey datasets.^[
The complete list of survey items is included in the Appendix.]
Together, these items were asked in `r n_countries` different countries in at least two time points over the `r n_years` years `r year_range`, yielding a total of `r n_cyi` country-year-item observations.
Observations for every year in each country surveyed would total `r total_cy`, and a complete set of country-year-items would include `r {n_countries * n_years * n_items} %>% scales::comma()` observations.
Viewed from this complete-data perspective, the available data can be seen to be very, very sparse.
On the other hand, we do have in the source data `r n_cy` country-years for which we have at least _some_ information about the extent of the acceptance of homosexuality in the population, that is, some `r round(covered_share_of_spanned)`% of the `r spanned_cy` country-years spanned by the data we collected.
Still, the many different survey items employed render these data incomparable and make them difficult to use together.

<!-- This should be reworded -->

Observations for every year in each country surveyed would total `r total_cy`, and a complete set of country-year-items would include `r {n_countries * n_years * n_items} %>% scales::comma()` observations.
Viewed from this complete-data perspective, the available data can be seen to be very, very sparse.
More optimistically, we do have in the source data `r n_cy` country-years for which we have at least _some_ information about the extent of the acceptance of homosexuality in the population, that is, some `r round(covered_share_of_spanned)`% of the `r spanned_cy` country-years spanned by the data we collected.
But there can be no denying that the many different survey items employed renders these data incomparable and difficult to use together.

```{r itemcountry, fig.cap="Countries and Years with the Most Observations in the Source Data \\label{item_country_plots}", fig.height=3.5, fig.pos='h', cache=FALSE}
items_plot <- dcpo_input_raw1 %>%
  distinct(country, year, item) %>%
  count(item) %>%
  arrange(desc(n)) %>% 
  head(12) %>% 
  ggplot(aes(forcats::fct_reorder(item, n, .desc = TRUE), n)) +
  geom_bar(stat = "identity") +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        axis.text.x  = element_text(angle = 90, vjust = .45, hjust = .95),
        axis.title.y = element_text(size = 9),
        plot.title = element_text(hjust = 0.5, size = 11)) +
  ylab("Country-Years\nObserved") +
  ggtitle("Items")

just10_cy <- dcpo_input_raw1 %>% filter(item == "just10") %>% distinct(country, year) %>% nrow()

just10_surveys <- dcpo_input_raw1 %>% filter(item == "just10") %>% distinct(survey) %>% pull(survey)

countries_plot <- dcpo_input_raw1 %>%
  mutate(country = if_else(stringr::str_detect(country, "United"),
                           stringr::str_replace(country, "((.).*) ((.).*)", "\\2.\\4."),
                           country)) %>% 
  distinct(country, year, item) %>% 
  count(country) %>%
  arrange(desc(n)) %>% 
  head(12) %>% 
  ggplot(aes(forcats::fct_reorder(country, n, .desc = TRUE), n)) +
  geom_bar(stat = "identity") +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        axis.text.x  = element_text(angle = 90, vjust = .45, hjust = .95),
        axis.title.y = element_text(size = 9),
        plot.title = element_text(hjust = 0.5, size = 11)) +
  ylab("Year-Items\nObserved") +
  ggtitle("Countries")

cby_plot <- dcpo_input_raw1 %>%
  mutate(country = if_else(stringr::str_detect(country, "United"),
                           stringr::str_replace(country, "((.).*) ((.).*)", "\\2.\\4."),
                           country),
         country = stringr::str_replace(country, "South", "S.")) %>% 
  distinct(country, year) %>%
  count(country) %>% 
  arrange(desc(n)) %>% 
  head(12) %>% 
  ggplot(aes(forcats::fct_reorder(country, n, .desc = TRUE), n)) +
  geom_bar(stat = "identity") +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        axis.text.x  = element_text(angle = 90, vjust = .45, hjust = .95),
        axis.title.y = element_text(size = 9),
        plot.title = element_text(hjust = 0.5, size = 11)) +
  ylab("Years\nObserved") +
  ggtitle("Countries")


ybc_plot <- dcpo_input_raw1 %>%
  distinct(country, year) %>%
  count(year, name = "nn") %>%
  ggplot(aes(year, nn)) +
  geom_bar(stat = "identity") +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        # axis.text.x  = element_text(angle = 90, vjust = .45, hjust = .95),
        axis.title.y = element_text(size = 9),
        plot.title = element_text(hjust = 0.5, size = 11)) +
  ylab("Countries\nObserved") +
  ggtitle("Years")

us_obs <- dcpo_input_raw1 %>% 
  distinct(country, year, item) %>%
  count(country) %>%
  filter(country == "United States") %>%
  pull(n)

others <- dcpo_input_raw1 %>%
  distinct(country, year, item) %>%
  count(country) %>%
  arrange(desc(n)) %>%
  slice(2:5) %>%
  pull(country) %>% 
  paste(collapse = ", ") %>% 
  str_replace(", (\\w+)$", ", and \\1")

countries_cp <- dcpo_input_raw1 %>%
  mutate(country = if_else(stringr::str_detect(country, "United"),
                           stringr::str_replace(country, "((.).*) ((.).*)", "\\2.\\4."),
                           country),
         country = stringr::str_replace(country, "South", "S.")) %>% 
  distinct(country, year, item) %>%
  count(country) %>% 
  arrange(desc(n)) %>% 
  head(12) %>% 
  pull(country)

countries_cbyp <- dcpo_input_raw1 %>%
  mutate(country = if_else(stringr::str_detect(country, "United"),
                           stringr::str_replace(country, "((.).*) ((.).*)", "\\2.\\4."),
                           country),
         country = stringr::str_replace(country, "South", "S.")) %>% 
  distinct(country, year) %>%
  count(country) %>% 
  arrange(desc(n)) %>% 
  head(12) %>% 
  pull(country)

adding <- setdiff(countries_cbyp, countries_cp) %>% 
  knitr::combine_words()

dropping <- setdiff(countries_cp, countries_cbyp) %>% 
  knitr::combine_words()

y_peak_year <- dcpo_input_raw1 %>%
  distinct(country, year) %>%
  count(year, name = "nn") %>% 
  filter(nn == max(nn)) %>% 
  pull(year)

y_peak_nn <- dcpo_input_raw1 %>%
  distinct(country, year) %>%
  count(year, name = "nn") %>% 
  filter(nn == max(nn)) %>% 
  pull(nn)

data_poorest <- dcpo_input_raw1 %>%
  distinct(country, year, item) %>%
  count(country) %>%
  arrange(n) %>%
  filter(n == 2) %>%
  pull(country) %>% 
  knitr::combine_words()

wordify_numeral <- function(x) setNames(c("one", "two", "three", "four", "five", "six", "seven", "eight", "nine", "ten", "eleven", "twelve", "thirteen", "fourteen", "fifteen", "sixteen", " seventeen", "eighteen", "nineteen"), 1:19)[x]

n_data_poorest <- {data_poorest %>%
    str_split(",") %>% 
    first()} %>% 
  length() %>% 
  wordify_numeral()

(countries_plot + cby_plot) / (ybc_plot)
```

Consider the most frequently asked item in the data we collected, which asks respondents whether they think homosexuality "can always be justified, never be justified, or something in between," using a ten-point scale.
Employed by the Asia Barometer, the European Values Survey, the Latinobarómetro, and the World Values Survey, this question was asked in a total of `r just10_cy` different country-years.
That this constitutes only `r {just10_cy*100/(spanned_cy %>% str_replace(",", "") %>% as.numeric())} %>% round()`% of the country-years spanned by our data---and remember, this is the _most common_ survey item---again underscores just how sparse and incomparable the available public opinion data is on this topic.

The upper left panel of Figure\nobreakspace{}\ref{item_country_plots} shows the dozen countries with the highest count of country-year-item observations.
The United States, with `r us_obs` observations, is far and away the best represented country in the source data, followed by `r others`.
At the other end of the spectrum, `r n_data_poorest` countries---`r data_poorest`---have only the minimum two observations required to be included in the source dataset at all.
The upper right panel shows the twelve countries with the most years observed; this group is similar, but with `r adding` joining the list and `r dropping` dropping off.
The bottom panel counts the countries observed in each year and reveals just how few relevant survey items were asked before 1990.
Country coverage reached its peak in `r y_peak_year`, when surveys in `r y_peak_nn` countries included items on homosexuality.
In the next section, we describe how we are able to make use of all of this sparse and incomparable survey data to generate estimates of public opinion that are comparable across countries and years using a latent variable model.

```{r dcpo_input}
dcpo_input <- DCPOtools::format_dcpo(dcpo_input_raw1,
                                     scale_q = "approve4",
                                     scale_cp = 2)
save(dcpo_input, file = here::here("data", "dcpo_input.rda"))
```


```{r dcpo, eval=FALSE, include=FALSE, results=FALSE}
iter <- 1500
 
dcpo <- cmdstan_model("~/Documents/Projects/DCPO/inst/stan/dcpo.stan")

dcpo_output <- dcpo$sample(
   data = dcpo_input[1:13], 
   max_treedepth = 14,
   adapt_delta = 0.99,
   step_size = 0.005,
   seed = 324, 
   chains = 4, 
   parallel_chains = 4,
   iter_warmup = iter/2,
   iter_sampling = iter/2,
   refresh = iter/50
 )

results_path <- here::here(file.path("data", 
                                     iter, 
                                  {str_replace_all(Sys.time(),
                                                      "[- :]",
                                                   "") %>%
                                         str_replace("\\d{2}$",
                                                     "")}))

dir.create(results_path, 
           showWarnings = FALSE, 
           recursive = TRUE)

dcpo_output$save_data_file(dir = results_path,
                           random = FALSE)
dcpo_output$save_output_files(dir = results_path,
                              random = FALSE)
```

```{r dcpo_results, cache=FALSE}
if (!exists("results_path")) {
  latest <- "202305140731"
  results_path <- here::here("data", "1500", latest)
  
  # Define OSF_PAT in .Renviron: https://docs.ropensci.org/osfr/articles/auth
  if (!file.exists(file.path(results_path, paste0("dcpo-", latest, "-1.csv")))) {
    dir.create(results_path, showWarnings = FALSE, recursive = TRUE)
    osf_retrieve_node("XXXXX") %>% 
      osf_ls_files() %>% 
      filter(name == latest) %>% 
      osf_download(path = here::here("data", "1000"))
  }
}

dcpo_output <- as_cmdstan_fit(here::here(results_path,
                                         list.files(results_path, pattern = "csv$")))
 

```

```{r dcpo_summary}
load(file = here::here("data", "dcpo_input.rda"))
theta_summary <- DCPOtools::summarize_dcpo_results(dcpo_input,
                                                   dcpo_output,
                                                   "theta")

res_cy <- nrow(theta_summary) %>% 
  scales::comma()

res_c <- theta_summary %>% 
  pull(country) %>% 
  unique() %>% 
  length()

save(theta_summary, file = here::here("data",
                                      "theta_summary.rda"))
```

```{r theta_results}
theta_results <- extract_dcpo_results(dcpo_input,
                                      dcpo_output,
                                      par = "theta")
```



```{r csplot, fig.cap="AoH Scores, Most Recent Available Year \\label{cs_mry}", fig.height=10, fig.width=8}
n_panes <- 2
axis_text_size <- 10

p1_data <- theta_summary %>%
  group_by(country) %>%
  top_n(1, year) %>%
  ungroup() %>%
  arrange(mean) %>%
  transmute(country_year = paste0(country, " (", year, ")") %>% 
              str_replace("’", "'"),
            estimate = mean,
            conf.high = q90,
            conf.low = q10,
            pane = n_panes - (ntile(mean, n_panes) - 1),
            ranked = as.factor(ceiling(row_number())))

p_theta <- ggplot(p1_data,
                  aes(x = estimate, y = ranked)) +
  geom_segment(aes(x = conf.low, xend = conf.high,
                   y = ranked, yend = ranked),
               na.rm = TRUE,
               alpha = .4) +
  geom_point(fill = "black", shape = 21, size = .5, na.rm = TRUE) +
  theme_bw() + theme(legend.position="none",
                     axis.text.x  = element_text(size = axis_text_size,
                                                 angle = 90,
                                                 vjust = .45,
                                                 hjust = .95),
                     axis.text.y  = element_text(size = axis_text_size),
                     axis.title = element_blank(),
                     strip.background = element_blank(), 
                     strip.text = element_blank(),
                     panel.grid.major = element_line(linewidth = .3),
                     panel.grid.minor = element_line(linewidth = .15)) +
  scale_y_discrete(breaks = p1_data$ranked, labels=p1_data$country_year) +
  coord_cartesian(xlim=c(0, 1)) +
  facet_wrap(vars(pane), scales = "free", nrow = 1)


p_theta +
  plot_annotation(caption = "Note: Gray whiskers represent 80% credible intervals.")

bottom5 <- p1_data %>% 
  arrange(ranked) %>% 
  slice(1:5) %>% 
  pull(country_year) %>% 
  str_replace(" \\(.*", "") %>% 
  knitr::combine_words()
```

Figure\nobreakspace{}\ref{cs_mry} displays the most recent available AOH score for each of the `r res_c` countries and territories in the dataset.
Iceland, the Netherlands, Belgium, and the Scandinavian countries are the places where the public is most accepting of homosexuality.
The latest scores for `r bottom5` indicate there is very little acceptance in those countries.

```{r tsplots, fig.cap="Acceptance Over Time Within Selected Countries \\label{ts}", fig.height=3.5}
countries <- c("Netherlands", "Sweden", "Ireland", "United States",
               "Argentina", "Mexico", "Taiwan", "Poland", 
               "China", "Ukraine", "Indonesia", "Russia", 
               "Nigeria", "Jamaica", "Armenia", "Uganda")

countries2 <- countries %>% 
  str_replace("United States", "U.S.")

c_res <- theta_summary %>% 
  filter(country %in% countries) %>%
  mutate(country = factor(str_replace(country, "United States", "U.S.") %>% 
           factor(levels = countries2)))

ggplot(data = c_res, aes(x = year, y = mean)) +
  theme_bw() +
  theme(legend.position = "none") +
  coord_cartesian(xlim = c(1985, 2020), ylim = c(0, 1)) +
  labs(x = NULL, y = "AoH Scores") +
  geom_ribbon(data = c_res, aes(ymin = q10, ymax = q90, linetype=NA), alpha = .25) +
  geom_line(data = c_res) +
  facet_wrap(~as_factor(country), nrow = 2) +
  theme(axis.text.x  = element_text(size=7,
                                    angle = 90,
                                    vjust = .45,
                                    hjust = .95),
        strip.background = element_rect(fill = "white", colour = "white")) +
  plot_annotation(caption = "Note: Countries are ordered by their AoH scores in their most recent\navailable year; gray shading represents 80% credible intervals.")
```

Figure\nobreakspace{}\ref{ts} displays how AoH scores have changed over time in sixteen countries.
It further underscores what is evident in Figure\nobreakspace{}\ref{cs_mry}: the cross-regional scope of the AoH dataset allows comparison of countries too often neglected in political science analyses [see @Wilson2021].
The figure also shows that while public opinion toward homosexuality has grown rapidly more accepting in some countries, such as Sweden and the United States, attitudes have changed much more gradually over time in others, like Poland and China. 
Acceptance has advanced and retreated somewhat as in Taiwan and more completely as in Russia.
And in countries such as Nigeria and Uganda, the extent of acceptance of homosexuality in the public has been steadily scant.
The breadth of these differences stand as a challenge to our explanations for the causes and consequences of public acceptance of homosexuality.


# Validating Acceptance of Homosexuality

```{r internal_val_dat, include=FALSE}
internal_tscs_dat <- dcpo_input_raw1 %>% 
  filter(item == "just10") %>%  
  mutate(title = "All Country-Years",
         neg = FALSE)

internal_cs_dat <- dcpo_input_raw1 %>% 
  filter(survey == "issp2008") %>%  
  mutate(title = "ISSP 2008: Religion III",
         neg = FALSE)

internal_ts_dat <- dcpo_input_raw1 %>% 
  filter(survey == "usgss" & item == "approve4") %>%  
  mutate(title = "United States",
         neg = FALSE)
```

```{r internalval, fig.height = 4, fig.cap = "Convergent Validation: Correlations Between AoH Scores and Individual Source-Data Survey Items \\label{internal_val}"}
internal_tscs_plot <- validation_plot(internal_tscs_dat,
                                lab_x = .1,
                                lab_y = 95) +
  theme_bw() +
  theme(legend.position="none",
        axis.text  = element_text(size=8),
        axis.title = element_text(size=9),
        plot.title = element_text(hjust = 0.5, size = 9),
        strip.background = element_blank()) +
  coord_cartesian(xlim = c(0,1), ylim = c(0,100)) +
  labs(x = "AoH Score",
       y = "% Responding Homosexuality Can,\nMore Often Than Not, Be Justified (6+ on 1-10 Scale)")

internal_cs_plot <- validation_plot(internal_cs_dat,
                                lab_x = .1,
                                lab_y = 95) +
  theme_bw() +
  theme(legend.position="none",
        axis.text  = element_text(size=8),
        axis.title = element_text(size=9),
        plot.title = element_text(hjust = 0.5, size = 9),
        # strip.text.x = element_text(size=5),
        strip.background = element_blank()) +
  coord_cartesian(xlim = c(0,1), ylim = c(0,100)) +
  labs(x = "AoH Score",
       y = "% Considering Same-Sex Sexual Relations\nWrong Only Sometimes or Not at All")

internal_ts_plot <- validation_plot(internal_ts_dat,
                                    lab_x = 1977,
                                    lab_y = .95) +
  theme_bw() +
  theme(legend.position="none",
        axis.text  = element_text(size=8),
        axis.title = element_text(size=9),
        plot.title = element_text(hjust = 0.5, size = 9),
        strip.background = element_blank()) +
  coord_cartesian(ylim = c(0,1)) +
  labs(x = "Year",
       y = "Score") +
  annotate("text", x = 2016, y = .49, size = 2,
           label = 'U.S. GSS') + # approve4
  annotate("text", x = 2020, y = .84, size = 2,
           label = "AoH Score")

internal_tscs_plot + internal_cs_plot + internal_ts_plot  +
  patchwork::plot_annotation(caption = "Note: Gray whiskers and shading represent 80% credible intervals.")
```

Before these estimates can be used, however, they must be validated: the mere fact that we can generate estimates for acceptance of homosexuality does not automatically mean that they are suitable for analysis. 
Just as with any other new measure, validation tests of cross-national latent variables are crucially important [see, e.g., @Hu2023].
Figure\nobreakspace{}\ref{internal_val} and Figure\nobreakspace{}\ref{external_val} provide evidence of this measure's validity with tests of convergent validation and construct validation.
Convergent validation refers to tests of whether a measure is empirically associated with alternative indicators of the same concept [@Adcock2001, 540].
In Figure\nobreakspace{}\ref{internal_val}, the AoH scores are compared to responses to individual source-data survey items that were used to generate them; this provides an 'internal' convergent validation test [see, e.g., @Caughey2019, 689; @Solt2020c, 10].
The left panel is a scatterplot of country-years in which the AoH scores are plotted against the percentage of respondents who gave an accepting response to the most commonly asked item in the source data: whether homosexuality can always be justified, scored ten, never be justified, scored zero, or something in between.
For this plot, responses six or greater are considered as indicating that whether respondents consider homosexuality justified more often than not.
The middle panel shows responses to the question with the most data-rich cross-section, "And what about sexual relations between two adults of the same sex, is it always wrong, almost always wrong, wrong only sometimes, or not wrong at all?" in the International Social Survey Program's 2008 module on Religion, plotting the latent variable of acceptance against the percentage who responded "wrong only sometimes" or "not at all."
Finally, in the right panel, the U.S. General Social Survey's series on this same item---the longest of any item in any single country in the source data---was used to evaluate how well the AoH scores capture change over time.
The correlations, estimated taking into account the uncertainty in the measures, are very strong in all three cases.

```{r ext_val1_dat, include=FALSE}
ext_dat1 <- read_csv(here("data-raw",
                         "surveys_extval.csv"),
                     col_types = "cccccc")

ext_issp_tradroles_dat <- ext_dat1 %>%
  filter(str_detect(survey, "issp")) %>%
  DCPOtools::dcpo_setup(datapath = here("..",
                                        "data",
                                        "dcpo_surveys")) %>%  
  mutate(title = "International Social Survey Program (8 Surveys)",
         neg = FALSE)

gm_laws_bd <- read_csv(here::here("data-raw", "gm_laws.csv"),
                    col_types = "cddddddc") %>% 
  mutate(country = countrycode::countrycode(country,
                                            "country.name",
                                            "country.name",
                                            warn = FALSE)) %>% 
  inner_join(theta_summary %>%
  group_by(country) %>%
  top_n(1, year) %>%
  ungroup(),
  by = "country") %>% 
  mutate(equality = case_when(!is.na(gm) ~ "marriage",
                              !is.na(civ) & is.na(gm) ~ "civil unions",
                              TRUE ~ "none") %>% 
           factor(levels = c("none", "civil unions", "marriage")))

gm_laws0 <- "https://en.wikipedia.org/wiki/Same-sex_marriage" %>% 
  read_html() %>% 
  html_table() %>% 
  first() %>% 
  select(X1)

gm_laws_dat <- gm_laws0 %>% 
  filter(str_detect(X1, "^Marriage")) %>% 
  mutate(X1 = str_replace_all(X1, "(Costa|New|South|United) ", "\\1") %>% 
           str_replace_all("\\d", "")) %>% 
  separate_rows(X1, sep="\\s+") %>% 
  mutate(country = str_replace(X1, "SouthAfrica", "South Africa") %>%
           countrycode::countrycode(
             "country.name", 
             "country.name",
             warn = FALSE),
         gm = 1) %>% 
  filter(!is.na(country)) %>% 
  select(country, gm) %>%
  bind_rows(tibble(country = c("Puerto Rico", "Northern Ireland"), gm = 1)) %>% 
  bind_rows(gm_laws0 %>% 
              filter(str_detect(X1, "^Civil")) %>% 
              mutate(X1 = str_replace_all(X1, "(Czech|San|Cayman) ", "\\1") %>% 
                       str_replace_all("\\d|[*]", "")) %>% 
              separate_rows(X1, sep="\\s+") %>% 
              filter(!str_detect(X1, ":|•")) %>% 
              mutate(country = countrycode::countrycode(X1,
                                                        "country.name", 
                                                        "country.name",
                                                        warn = FALSE),
                     civ = 1) %>% 
              filter(!is.na(country)) %>% 
              select(country, civ)) %>% 
  right_join(theta_summary %>%
                 group_by(country) %>%
                 top_n(1, year) %>%
                 ungroup(),
               by = "country") %>% 
  mutate(equality = case_when(!is.na(gm) ~ "marriage",
                              !is.na(civ) ~ "civil unions",
                              TRUE ~ "minimal/none") %>% 
           factor(levels = c("minimal/none", "civil unions", "marriage")),
         title = "Legal Recognition of Same-Sex Couples")

gm_laws_cor <- theta_results %>%
      inner_join(gm_laws_dat %>%
                   transmute(country,
                             year,
                             equality = as.numeric(equality)),
                 by = c("country", "year")) %>% 
      select(theta, equality, draw) %>% 
      nest(data = c(theta, equality)) %>% 
      mutate(r = lapply(data, function(df) cor(df)[2,1]) %>% 
               unlist()) %>%
      select(-data) %>% 
      summarize(r = paste("R =", sprintf("%.2f", round(mean(r), 2)))) %>% 
  mutate(equality = "minimal/none" %>% 
           factor(levels = c("minimal/none", "civil unions", "marriage")),
         title = "Legal Recognition of Same-Sex Couples")

ext_libdem_dat <- vdemdata::vdem %>%
  transmute(country = countrycode::countrycode(country_name,
                                            "country.name",
                                            "country.name"),
            year = year, 
            prop = v2x_libdem,
            se = v2x_libdem_sd, 
            title = "V-Dem",
            neg = FALSE) %>% 
  distinct(country, year, .keep_all = TRUE) %>% 
  right_join(theta_summary %>%
                 group_by(country) %>%
                 top_n(1, year) %>%
                 ungroup() %>% 
               select(country, year),
               by = c("country", "year")) %>% 
  filter(!is.na(prop))
```

```{r extval1, fig.cap="Construct Validation: Correlations Between AoH Scores and Acceptance of Homosexuality Survey Items \\label{ext_val1}", fig.height=4}
ext_issp_tradroles_plot <- validation_plot(ext_issp_tradroles_dat,
                                    lab_x = .1,
                                    lab_y = 95) +
  theme_bw() +
  theme(legend.position="none",
        axis.text  = element_text(size=8),
        axis.title = element_text(size=9),
        plot.title = element_text(hjust = 0.5, size = 9),
        strip.background = element_blank()) +
  coord_cartesian(xlim = c(0,1), ylim = c(0,100)) +
  labs(x = "AoH Score",
       y = "% Agreeing 'A husband's job is to earn money;\na wife's job is to look after the home and family'")

ext_gm_laws_plot <- ggplot(gm_laws_dat, aes(x = equality,
                                        y = mean)) +
  geom_violin(trim = TRUE, 
              scale = "count",
              aes(fill = equality)) +
  geom_boxplot(width = 0.05, 
               outlier.shape = 21,
               outlier.fill = "white",
               fill = "white",
               linetype = "dashed") + 
  geom_boxplot(width = 0.05, 
               outlier.shape = 21,
               outlier.fill = "white",
               fill = "white",
               aes(xmin = after_stat(lower), 
                   xmax = after_stat(upper))) +
  theme_bw() +
  theme(legend.position = "none",
        axis.text  = element_text(size = 10),
        axis.title = element_text(size = 11),
        plot.title = element_text(hjust = 0.3, size = 9),
        strip.background = element_blank()) +
  coord_cartesian(ylim = c(0, 1)) +
  scale_fill_grey(start = .65, end = .45) +
  labs(x = "",
       y = "AoH Score, Most Recent Available Year") +
  geom_label(data = gm_laws_cor, aes(x = equality,
                                     y = .95,
                                     label = r),
             size = 2) +
  facet_wrap(~ title, ncol = 4)

ext_libdem_plot <- validation_plot(ext_libdem_dat,
                                   lab_x = .1,
                                   lab_y = 95,
                                   survey = FALSE) + 
  theme_bw() +
  theme(legend.position="none",
        axis.text  = element_text(size=8),
        axis.title = element_text(size=9),
        plot.title = element_text(hjust = 0.5, size = 9),
        strip.background = element_blank()) +
  coord_cartesian(xlim = c(0,1), ylim = c(0,100)) +
  labs(x = "AoH Score, Most Recent Available Year",
       y = "Liberal Democracy Index")

ext_issp_tradroles_plot + ext_gm_laws_plot + ext_libdem_plot +
  plot_annotation(caption = "Note: Gray whiskers represent 80% credible intervals.")
```

Figure\nobreakspace{}\ref{ext_val1} moves on, then, to construct validation.
Construct validation refers to demonstrating, for some _other_ concept believed causally related to the concept a measure seeks to represent, that the measure being tested is empirically associated with measures of that other concept [@Adcock2001, 542].
More traditional attitudes toward gender roles are often argued to yield more intolerance of homosexuals [see, e.g., @Brown2008].
The left panel compares traditional attitudes, measured as the percentage of those agreeing or strongly agreeing with the statement, "A husband's job is to earn money; a wife's job is to look after the home and family," in eight ISSP surveys (Family and Changing Gender Roles in 1988, 1994, 2002, and 2012; and Religion in 1991, 1998, 2008, and 2018), with the AoH scores.
As a result of policy responsiveness, that is, the influence of public opinion on policy [see, e.g., @Lax2009], and policy feedback, the influence of policy on public opinion [see, e.g., @Abou-Chadi2019; @Earle2021], public acceptance of homosexuality is expected to be closely related to policies recognizing same-sex relationships.
The figure's center panel presents violin plots of the distribution of AoH scores in the most recent available year across three groups of countries: those that currently have no or minimal legal recognition of same-sex relationships, those that recognize civil unions, and those with marriage equality.
The gray-shaded 'violins' depict (mirrored) kernal density plots of the observations in each group; their areas are proportional to the number of observations.
The violins are inset with box-and-whisker plots showing the 25th percentile, median, and 75th percentile as horizontal lines in a box; the dashed vertical whiskers then extend to the farthest observation within 1.5 times the interquartile range, that is, the height of the box; and all observations beyond that distance are shown individually as white circles [see @Tukey1977].
A third oft-theorized relationship is that liberal democracies promote tolerant attitudes that lead to greater acceptance of homosexuality [see, e.g., @Adamczyk2019a].
The right panel plots the V-Dem Liberal Democracy Index against the AoH scores.
In each of these three cases, the relationship is in the expected direction and strong to very strong.
Together, the evidence of convergent and construct validation in Figures\nobreakspace{}\ref{ext_val1}\nobreakspace{}and\nobreakspace{}\ref{internal_val} demonstrate the validity of the AoH scores as measures of public acceptance of homosexuality.

# Testing Theories of Acceptance of Homosexuality: Revisiting 'Economic Inequality and Intolerance'

Macrointerest varies greatly around the world.
Figure\nobreakspace{}\ref{ts_plots} examines levels and trends in macrointerest in advanced democratic countries by displaying the changes of the public's expressed interest in politics over time in the thirty-seven democracies of the OECD.
While macrointerest scores approach and often exceed .6 in countries such as Denmark and Canada, in Chile they scarcely cross .25.
And although the public's political interest has held fairly steady over decades in many countries, in Czechia it dropped nearly half of the variable's entire theoretical range over the 1990s and 2000s before rebounding slightly since 2010, and increases of roughly a quarter of that range can be seen in, among others, Germany. 
There are considerable differences in the extent to which the public professes interest in politics both across countries and over time.

What explains these differences?
One straightforward explanation is that publics grow more interested in politics at election time.
Campaigns and elections attract media coverage and increase the information available to the public on the issues being contested, leading to increased interest in politics [see, e.g., @Beach2018; @Larsen2022].
Macrointerest within each country should be expected to be higher, therefore, in years in which national elections take place than in years without elections.

A second argument is that political institutions that share power, rather than concentrate it, yield politics that are more interesting and engaging.
Building on @Lijphart1999 and @Powell2000, @Kittilson2010 [, 992] argues that power-sharing institutions---parliamentarism, federalism, and proportional electoral rules---"send signals of inclusiveness to citizens, generating greater political engagement" while power-concentrating institutions "may generate perceptions of exclusion and deter involvement."
Macrointerest should be higher in countries with parliamentary and federal systems than in those without those features, and it should decline as the disproportionality between votes cast and seats won increases.

A third claim deals with the public's demand for accountability.
@Peterson2022 [, 203] advances this argument: "when there is information that something has gone wrong \ldots then voters should be more likely to attend to the actions of elected officials," but when "there is evidence of success \ldots voters should not waste their energies focusing on the activities of their representatives."
If democracy is a principal-agent problem with elected officials acting as self-interested agents and the public as their lazy but vengeful principal, then macrointerest should rise when times are bad and decline as conditions improve.

A final set of theories---each well established---contradicts the third.
Modernization theory holds that the public's interest in politics will increase as the national economy grows and household incomes expand [see, e.g., @Inglehart2005].
Unemployment has long been argued to not to motivate but rather to depress political interest; @Rosenstone1982 [, 26], for example, argued that "it causes a preoccupation with personal economic well-being, and as a result, the citizen withdraws from such external matters as politics."
And the relative power theory holds that greater income inequality, by increasingly concentrating political power in the hands of the wealthy, allows them greater power to shape the political agenda in ways that discourage the broader public from taking interest [see, e.g., @Solt2008].
In each of these circumstances, macrointerest is argued to grow in _good_ times and wither as the context worsens [see also @Stimson2015; @Peterson2022, 206].

Data to test these hypotheses regarding the causes of macrointerest are drawn from several sources.
The Democratic Electoral Systems (DES) dataset updated in @Bormann2022 provides information about the timing of elections, yielding a dichotomous variable coded one in election years and zero when no election was held.
The three institutional variables are measured as in @Kittilson2010.
Data on parliamentarism, a dichotomous variable coded one in pure parliamentary systems and zero otherwise, is also sourced from the DES.
Federalism is a third dichotomous variable, coded one in countries with strong federal systems [see @Lijphart1999] and zero in all others.
The proportionality of the electoral system is measured using the Gallagher least-squares index of disproportionality, which measures the disparity between parties' vote shares and their seat shares [@Gallagher1991, 40-41].
The context of good times and bad was measured with data on GDP per capita, national GDP growth, and unemployment from OECD.Stat [@OECD2023] and on the Gini index of disposable income inequality from the Standardized World Income Inequality Database [@Solt2020].

```{r wdi}
wdi <- WDI::WDI(indicator = "NY.GDP.PCAP.KD") %>% 
    transmute(country = countrycode(iso3c, 
                                    "iso3c",
                                    "country.name",
                                    warn = FALSE),
              year,
              gdppc = NY.GDP.PCAP.KD) %>% 
    filter(!is.na(country) & !is.na(gdppc))
```

```{r swiid_data}
if (!file.exists(here("data-raw",
                      "swiid9_4",
                      "swiid9_4_summary.csv"))) {
download.file("https://dataverse.harvard.edu/api/access/datafile/6716676", "data-raw/swiid9_4.zip")
unzip(here("data-raw", "swiid9_4.zip"), exdir = here("data-raw"))
file.remove("data-raw", "swiid9_4.zip")
}

swiid_summary <- read_csv(here("data-raw",
                               "swiid9_4",
                               "swiid9_4_summary.csv"),
                          col_types = "cddddddddd") %>% 
  mutate(country = countrycode::countrycode(country,
                                            "country.name",
                                            "country.name",
                                            warn = FALSE)) %>% 
  select(country, year, gini_disp, gini_disp_se)
```

```{r gm_laws}
gm_laws <- "https://en.wikipedia.org/wiki/Same-sex_marriage" %>% 
  read_html() %>% 
  html_table() %>% 
  nth(7) %>% 
  separate_longer_delim(X2, ")") %>% 
  mutate(place = str_replace(X2, " \\(.*", "") %>% 
           str_trim(side = "both") %>% 
           str_replace(" \\[.*", "")) %>% 
  filter(!str_detect(place,
                     "(New (Mexi|Bruns|Jers))|Indian|Distr|County|State of")) %>% 
  mutate(country = if_else(place == "Guerrero", # last Mexican state to recognize
                           "Mexico",
                           countrycode(place,
                                       "country.name",
                                       "country.name",
                                       warn = FALSE))) %>% 
  filter(!is.na(country)) %>% 
  transmute(year = X1,
            country,
            gm = 1)
```

```{r culture}
culture <- read_csv(file = here("data-raw", "culture.csv"),
                    col_types = "cdddddd") %>% 
  bind_rows(tibble(country = "Côte d’Ivoire", 
                   catholic = 0,
                   eastern = 0,
                   orthodox = 0,
                   protestant = 0,
                   islamic = 1,
                   ex_com = 0))
```

```{r data_combo}
data_combo <- theta_summary %>% 
  left_join(wdi,
            by = c("country", "year")) %>% 
  left_join(swiid_summary,
            by = c("country", "year")) %>% 
  left_join(culture,
            by = "country") %>% 
  drop_na(mean:gini_disp_se) %>% 
  left_join(gm_laws,
            by = c("country", "year")) %>% 
  group_by(country) %>% 
  fill(gm) %>% 
  mutate(gm = if_else(is.na(gm), 0, gm), 
         gm_mean = mean(gm),
         gm_diff = gm - gm_mean,
         gini_mean = mean(gini_disp),
         gini_mean_se = sqrt(sum(gini_disp_se^2))/
           length(gini_disp),
         gini_diff = (gini_disp - gini_mean),
         gini_diff_se = sqrt(gini_disp_se^2 + gini_mean_se^2)/2,
         gdppc_mean = mean(gdppc/1000),
         gdppc_diff = gdppc/1000 - gdppc_mean
  ) %>% 
  ungroup()
```

```{r m1_results, include=FALSE}
if (!file.exists(here::here("data", "m1_results.rda"))) {
  oecd_democracies <- rvest::session("https://en.wikipedia.org/wiki/OECD") %>% 
    rvest::html_table() %>%
    nth(6) %>%
    mutate(country = countrycode::countrycode(Country,
                                              "country.name",
                                              "country.name")) %>% 
    pull(country) %>% 
    setdiff(c("Turkey", "Hungary"))

  m1 <- brm(formula = bf(mean*100 | mi(sd*100) ~ 
                           me(gini_mean, gini_mean_se) +
                           me(gini_diff, gini_diff_se) +
                           gdppc_mean + gdppc_diff +
                           gm_mean + gm_diff +
                           catholic +
                           orthodox +
                           eastern +
                           ex_com +
                           (1 | country) + (1 | year)),  
            data = data_combo %>% 
              filter(country %in% oecd_democracies),
            backend = "cmdstanr",
            warmup = 500, 
            iter = 1000, 
            chains = 4, 
            cores = 4,
            seed = 324)

    named_vars <- tribble(~var_name, ~`.variable`, ~order,
                        "Income Inequality, Mean", "bsp_megini_meangini_mean_se", 1,
                        "Income Inequality, Difference",
                                                  "bsp_megini_diffgini_diff_se", 2,
                        "GDPpc, Mean", "b_gdppc_mean", 3,
                        "GDPpc, Difference", "b_gdppc_diff", 4, 
                        "Marriage Equality, Mean", "b_gm_mean", 5,
                        "Marriage Equality, Difference", "b_gm_diff", 6, 
                        "Catholic", "b_catholic", 7,
                        "Orthodox", "b_orthodox", 8,
                        "Eastern", "b_eastern", 9,
                        "Islamic", "b_islamic", 10,
                        "Ex-Communist", "b_ex_com", 11)
      
  doubled_sd <- m1$data %>% 
    select(-`mean * 100`, -mean, -sd,
           -country, -year, -ends_with("_se")) %>% 
    summarize(across(everything(), by2sd)) %>% 
    pivot_longer(everything()) %>% 
    transmute(`.variable` = case_when(name == "gini_mean" ~ 
                                        "bsp_megini_meangini_mean_se",
                                      name == "gini_diff" ~
                                        "bsp_megini_diffgini_diff_se",
                                      TRUE ~ paste0("b_", name)),
              sd2 = if_else(`.variable` == "b_gm_diff", 1, value)) %>% 
    left_join(named_vars, by = join_by(`.variable`))
  
  coef_data0 <- m1 %>% 
    tidybayes::gather_draws(`bs?p?_.*`, regex = TRUE) %>% 
    filter(!`.variable`=="b_Intercept") %>% 
    left_join(doubled_sd, by = join_by(.variable)) %>% 
    arrange(order)
  
  cy_summary <- m1$data %>%
    count(country) %>%
    pull(n) %>%
    summary()
  
  save(doubled_sd, coef_data0, cy_summary, 
       file = here::here("data", "m1_results.rda"))
} else {
  load(file = here::here("data", "m1_results.rda"))
}
```

```{r m2_results}
if (!file.exists(here::here("data", "m2_results.rda"))) {
  m2 <- brm(formula = bf(mean*100 | mi(sd*100) ~ 
                           me(gini_mean, gini_mean_se) +
                           me(gini_diff, gini_diff_se) +
                           gdppc_mean + gdppc_diff +
                           gm_mean + gm_diff +
                           catholic +
                           orthodox +
                           eastern +
                           islamic +
                           ex_com +
                           (1 | country) + (1 | year)),  
            data = data_combo,
            backend = "cmdstanr",
            warmup = 500, 
            iter = 1000, 
            chains = 4, 
            cores = 4,
            seed = 324)
  
  doubled_sd_all <- m2$data %>% 
    select(-`mean * 100`, -mean, -sd,
           -country, -year, -ends_with("_se")) %>% 
    summarize(across(everything(), by2sd)) %>% 
    pivot_longer(everything()) %>% 
    transmute(`.variable` = case_when(name == "gini_mean" ~ 
                                        "bsp_megini_meangini_mean_se",
                                      name == "gini_diff" ~
                                        "bsp_megini_diffgini_diff_se",
                                      TRUE ~ paste0("b_", name)),
              sd2 = if_else(`.variable` == "b_gm_diff", 1, value)) %>% 
    left_join(named_vars, by = join_by(`.variable`)) %>% 
    arrange(order)
  
  coef_data0_all <- m2 %>% 
    tidybayes::gather_draws(`bs?p?_.*`, regex = TRUE) %>% 
    filter(!`.variable`=="b_Intercept") %>% 
    left_join(doubled_sd_all, by = join_by(.variable))
  
  cy_summary_all <- m2$data %>%
    count(country) %>%
    pull(n) %>%
    summary()
  
  save(doubled_sd_all, coef_data0_all, cy_summary_all,
       file = here::here("data", "m2_results.rda"))
} else {
  load(file = here::here("data", "m2_results.rda"))
}  

```


The resulting dataset comprises the thirty-six OECD democracies, each observed in twenty-one (Costa Rica) to forty-nine (the United States) consecutive years (mean: `r cy_summary %>% nth(4) %>% round(1)` years, median: `r cy_summary %>% nth(3)` years).
@Shor2007 shows that the best way to analyze such pooled time series is by using a Bayesian multilevel model that includes varying intercepts for each country and for each year. 
Varying intercepts for each country help account for heteroskedasticity across space due to, e.g., omitted variable bias, while permitting the inclusion of time-invariant predictors such as religious heritage and communist past.
Varying intercepts for each year take into account 'time shocks' that operate on all countries simultaneously [@Shor2007, 171-172].
We further employ the 'within-between random effects' specification, meaning each of the time-varying predictors is decomposed into its time-invariant country mean and the difference between each country-year value and this country mean.
The time-varying difference variables capture the short-term effects of the predictors, while the time-invariant country-mean variables reflect their---often different---long-run, "historical" effects [@Bell2015, 137].
This specification has been shown superior to fixed effects and other commonly used TSCS specifications for addressing omitted variable bias and endogeneity [see @Bell2015].
The measurement uncertainty in the data for both acceptance of homosexuality and income inequality was incorporated into the analysis as well [see @Tai2022].
The model was estimated using the `brms` R package [@Burkner2017].

```{r resplot, fig.cap="Predicting Acceptance of Homosexuality \\label{model}", fig.height = 5.5, fig.width = 7.5}
ordered <- doubled_sd_all %>%
  pull(var_name) %>% 
  rev()

coef_data <- coef_data0 %>% 
  mutate(std_coef = round(.value * sd2, 1),
         term = factor(var_name, levels = ordered)) %>%
  ggdist::median_qi(std_coef, .width = c(.8, .9, .95)) %>%
  mutate(ci = paste0(round(.lower, 1), " to ", round(.upper, 1))) %>%
  left_join(doubled_sd, ., by = join_by(.variable))

coef_data_all <- coef_data0_all %>% 
  mutate(std_coef = round(.value * sd2, 1),
         term = factor(var_name, levels = ordered)) %>%
  ggdist::median_qi(std_coef, .width = c(.8, .9, .95)) %>%
  mutate(ci = paste0(round(.lower, 1), " to ", round(.upper, 1))) %>%
  left_join(doubled_sd_all, ., by = join_by(.variable))

coef_data0 %>% 
  mutate(sample = "oecd") %>% 
  bind_rows(coef_data0_all %>% mutate(sample = "all")) %>% 
  mutate(std_coef = round(.value * sd2, 1),
         term = factor(var_name, levels = ordered)) %>% 
  ggplot(aes(y = term,
             x = std_coef,
             fill = sample,
             color = sample)) +
  stat_halfeye(.width = c(.8, .9, .95),
               alpha = .3,
               point_alpha = 1) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme_light() +
  scale_fill_manual(name = NULL,
                    values = c("red2", "blue"), 
                    breaks = c("all", "oecd"),
                    labels = c("All Countries", 
                               "OECD Democracies")) +
  scale_color_manual(name = NULL, 
                     values = c("red4", "navy"), 
                     breaks = c("all", "oecd"),
                     labels = c("All Countries", 
                               "OECD Democracies")) +
  labs(fill = NULL, 
       color = NULL) +
  theme(legend.justification=c(1,0),
        legend.position=c(.99, .01),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "grey80")) +
  guides(color = guide_legend(reverse = TRUE),
         fill = guide_legend(reverse = TRUE)) +
  xlab(NULL) +
  ylab(NULL) +
  plot_annotation(caption = "Notes: Dots indicate posterior means; whiskers, from thickest to thinnest, describe 80%,\n90%, and 95% credible intervals; shading depicts the posterior probability density function.")
```


\pagebreak
# References {.unnumbered}

::: {#refs-text}
:::

\pagebreak

```{=tex}
\renewcommand{\baselinestretch}{1}
\selectfont
\maketitle
\selectfont
```
```{=tex}
\pagenumbering{arabic}
\renewcommand*{\thepage}{A\arabic{page}}
```
```{=tex}
\setcounter{figure}{0}
\renewcommand*{\thefigure}{A\arabic{figure}}
```
```{=tex}
\vspace{-.5in}
\begin{center}
\begin{Large}
Appendices
\end{Large}
\end{center}
```

# Appendix A: Survey Items Used to Estimate Acceptance of Homosexuality
National and cross-national surveys have often included questions tapping interest in politics over the past four decades, but the resulting data are both sparse, that is, unavailable for many countries and years, and incomparable, generated by many different survey items.
In all, I identified `r n_items` such survey items that were asked in no fewer than five country-years in countries surveyed at least twice; these items were drawn from `r n_surveys` different survey datasets.
These items are listed in the table below, along with the dispersion ($\alpha$) and difficulty ($\beta$) scores estimated for each from the DCPO model.
Lower values of dispersion indicate questions that better identify publics with a higher level of trust from those with lower.
Items have one less difficulty score than the number of response categories.
Survey dataset codes correspond to those used in the `DCPOtools` R package [@Solt2019]; they appear in decreasing order of country-years contributed.

Together, the survey items in the source data were asked in `r n_countries` different countries in at least two time points over `r n_years` years, `r year_range`, yielding a total of `r n_cyi` country-year-item observations.
The number of items observed in the source data for each country-year is plotted in Figure\nobreakspace{}\ref{obs_by_cy} below.
The estimates of tolerance in country-years with more observed items are more precise.
In country-years with fewer observed items, the estimates rely more heavily on the random-walk prior and are therefore more uncertain, and when there are no observed items, the estimates rely _entirely_ on the random-walk prior and so uncertainty increases still further.

\pagebreak

\noindent Table A1: Indicators Used in the Acceptance of Homosexuality Latent Variable Model

```{r dcpo_items}
alpha_results <- DCPOtools::summarize_dcpo_results(dcpo_input,
                                        dcpo_output,
                                        pars = "alpha") %>% 
  transmute(item = question,
            dispersion = mean)

beta_results <- DCPOtools::summarize_dcpo_results(dcpo_input,
                                       dcpo_output,
                                       "beta") %>% 
  group_by(question) %>% 
  summarize(difficulties0 = paste0(sprintf("%.2f", round(mean, 2)),
                                   collapse = ", ")) %>% 
  mutate(item = question,
         cp = if_else(str_detect(item, "threestate"),
                      2, 
                      as.numeric(str_extract(item, "\\d+")) - 1),
         term = str_glue("(( ?-?[0-9].[0-9][0-9]?,?){{{cp}}})"),
         difficulties = str_extract(difficulties0, 
                                    term) %>%
           str_replace(",$", "") %>% 
           str_trim()) %>% 
  transmute(item, difficulties)
                                    
items_summary <- dcpo_input_raw1 %>%
  dplyr::select(country, year, item, survey) %>%
  separate_rows(survey, sep=",\\s+") %>% 
  distinct() %>%
  group_by(item) %>% 
  mutate(survey = str_extract(survey, "^[a-z]*"),
         all_surveys = paste0(unique(survey), collapse = ", ")) %>% 
  ungroup() %>% 
  distinct(country, year, item, .keep_all = TRUE) %>% 
  group_by(item) %>% 
  mutate(n_cy = n()) %>% 
  ungroup() %>%
  distinct(item, n_cy, all_surveys) %>% 
  left_join(surveys_gm %>%
              select(item, question_text, response_categories) %>%
              distinct(item, .keep_all = TRUE),
            by = "item") %>% 
  left_join(alpha_results, by = "item") %>% 
  left_join(beta_results, by = "item") %>% 
  arrange(-n_cy)
```

```{r dcpo_items_table}  
items_summary %>% 
  transmute(`Survey\nItem\nCode` = item,
            `Country-Years` = as.character(n_cy),
            `Question Text` = str_replace(question_text, "([^(]*)\\(.*", "\\1"),
            `Response Categories` = response_categories,
            `Dispersion` = dispersion,
            `Difficulties`= difficulties,
            `Survey Dataset Codes` = all_surveys) %>% 
  modelsummary::datasummary_df(output = "kableExtra",
                               longtable = TRUE) %>% 
  kableExtra::column_spec(1, width = "7em") %>%
  kableExtra::column_spec(2, width = "4em") %>%
  kableExtra::column_spec(3, width = "13em") %>%
  kableExtra::column_spec(4, width = "16em") %>%
  kableExtra::column_spec(5, width = "4em") %>%
  kableExtra::column_spec(c(6, 7), width = "8em") %>% 
  kableExtra::kable_styling(font_size = 7) %>%
  kableExtra::kable_styling(latex_options = c("repeat_header")) %>%
  kableExtra::kable_styling(latex_options = "striped")
```

```{r obs, fig.height = 9, fig.width = 6.5, fig.cap = "Source Data Observations by Country and Year \\label{obs_by_cy}"}
dcpo_input_raw1 %>% 
  mutate(country = str_replace(country, "’", "'")) %>% 
  distinct(country, year, item, cc_rank) %>% 
  group_by(country, year) %>% 
  summarize(n = n(),
            cc_rank = mean(cc_rank)) %>% 
  ungroup() %>% 
  distinct() %>% 
  ggplot(aes(x = year, 
             y = forcats::fct_reorder(country, cc_rank),
             fill = n)) + 
  geom_tile() +
  scale_fill_viridis_b(option = "B",
                       direction = -1,
                       show.limits = TRUE,
                       n.breaks = 7,
                       name = "Observations") +
  labs(x = NULL, y = NULL) +
  scale_x_continuous(breaks=seq(1972, 2024, 4)) +
  scale_y_discrete(position = "right") +
  theme(legend.justification=c(0, 0), 
        legend.position=c(0.01, 0.01),
        axis.text.y  = element_text(size = 7)) 
```



\pagebreak
